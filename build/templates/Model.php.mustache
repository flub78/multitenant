<?php
/**
 * This file is generated from a template with metadata extracted from the data model.
 * If modifications are required, it is important to consider if they should be done in the template
 * or in the generated file, in which case caution must be exerted to avoid overwritting.
 */

namespace App\Models\Tenants;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Models\ModelWithLogs;
use App\Helpers\Config;
use Carbon\Carbon;
use Carbon\Exceptions\InvalidFormatException;
{{factory_referenced_models}}

/**
 * {{class_name}} model
 *
 * Acces to the percistency layer
 {{#is_view}}
 * {{table}} is a MySQL view
{{/is_view}}
{{^is_view}}
 * {{table}} is a regular table not a MySQL view
{{/is_view}}
 *
 * @author fred
 *
 */
class {{class_name}} extends ModelWithLogs {

{{^is_view}}
    use HasFactory;
{{/is_view}}

    /**
     * The associated database table
     */
    protected $table = '{{table}}';
 
 {{^is_view}}   
{{#primary_index}}
    /**
     * The primary key associated with the table.
     *
     * @var string
     */
    protected $primaryKey = '{{primary_index}}';

{{/primary_index}}
    /**
     * The attributes that are mass assignable.
     *
     * @var array
     */
	protected $fillable = [{{& fillable_names}}];
{{/is_view}}
{{#is_referenced}}

    /**
     * Return a human readable unique string
     */
    public function image() {
        return "{{element}}_" . $this->{{primary_index}};
    }
    
    /**
     * Return a selector to select one element
     */
    public static function selector($where = []) {
        ${{table}} = {{class_name}}::where($where)->get();
        $res = [];
        foreach (${{table}} as ${{element}}) {
            $res[] = ['name' => ${{element}}->image(), 'id' => ${{element}}->{{primary_index}}];
        }
        return $res;
    }
{{/is_referenced}}
{{#foreign_key_list}}
    
    /**
     * Get the image of the referenced {{&foreign_element}}
     * 
     * @return String
     */
    public function {{&foreign_element}}_image() {
        ${{&foreign_element}} = {{&foreign_class}}::findOrFail ( $this->{{&foreign_element}}_id );
        return ${{&foreign_element}}->image();
    }

{{/foreign_key_list}}	
{{#date_mutators}}

    /**
     * Get the {{&field_name}} date
     *
     * @param  string  $value date in MySql format
     * @return string the date in local format
     */
    public function get{{&field_name}}Attribute($value) {
        if (!trim($value)) return $value;
        $db_format = 'Y-m-d';
        try {
            $date = Carbon::createFromFormat($db_format, $value);
        } catch (InvalidFormatException $e) {
            echo "get{{&field_name}}Attribute($value) " . $e->getMessage();
            exit;
        }
        $date->tz(Config::config('app.timezone'));
        $result = $date->format(__('general.date_format'));
        return $result;
    }
    
    /**
     * Set the {{&field_name}} date
     *
     * @param  string  $value date in local format
     */
    public function set{{&field_name}}Attribute($value) {
        if (!trim($value)) return $value;
        $db_format = 'Y-m-d';
        $date = Carbon::createFromFormat(__('general.date_format'), $value);
        $this->attributes['{{&field}}'] = $date->format($db_format);
    }
{{/date_mutators}}
{{#datetime_mutators}}

    /**
     * Get the {{&field_name}} datetime
     *
     * @param  string  $value datetime in MySql format
     * @return string the datetime in local format
     */
    public function get{{&field_name}}Attribute($value) {
        if (!trim($value)) return $value;
        $db_format = 'Y-m-d H:i:s';
        try {
            $datetime = Carbon::createFromFormat($db_format, $value);
        } catch (InvalidFormatException $e) {
             echo "get{{&field_name}}Attribute($value) " . $e->getMessage();
            exit;
       }
        $datetime->tz(Config::config('app.timezone'));
        $result = $datetime->format(__('general.datetime_format'));
        return $result;
    }
    
    /**
     * Set the {{&field_name}} datetime
     *
     * @param  string  $value datetime in local format
     */
    public function set{{&field_name}}Attribute($value) {
        if (!trim($value)) return $value;
        $db_format = 'Y-m-d H:i:s';
        $datetime = Carbon::createFromFormat(__('general.datetime_format'), $value);
        $this->attributes['{{&field}}'] = $datetime->format($db_format);
    }
          
    /**
     * Get the {{&field_name}} date
     * 
     * @param String $value
     * @return string
     */
    public function get{{&field_name}}DateAttribute($value) {
        $result = substr($this->{{&field}}, 0, 10);
        return $result;
    }

    /**
     * Get the {{&field_name}} time
     * 
     * @param String $value
     * @return string
     */
    public function get{{&field_name}}TimeAttribute($value) {
        $result = substr($this->{{&field}}, 11, 5);
        return $result;
    }
    
    /**
     *  Set the {{&field_name}} date
     *  
     * @param String $value
     */
    public function set{{&field_name}}DateAttribute($value) {
        if (!trim($value)) return $value;
        $time = ($this->{{&field}}_time) ? $this->{{&field}}_time : "00:00";
        $local_datetime = $value . " " . $time;    
        $this->set{{&field_name}}Attribute($local_datetime);
    }
    
    /**
     * Set the {{&field_name}} time
     * 
     * @param String $value
     */
    public function set{{&field_name}}TimeAttribute($value) {
        if (!trim($value)) return $value;        
        $local_datetime = $this->{{&field}}_date . " " . $value;
        $this->set{{&field_name}}Attribute($local_datetime);
    }
    
{{/datetime_mutators}}
{{#currency_mutators}}

    /**
     * Get the {{&field_name}} currency
     *
     * @param  float  $value
     * @return string the value formatted for local currency
     */
    public function get{{&field_name}}Attribute($value) {
        if (!trim($value)) return $value;
        $result = $value;
        return $result;
    }
{{/currency_mutators}}
{{#float_mutators}}

    /**
     * Get the {{&field_name}} float
     *
     * @param  float  $value
     * @return the value with the correct number of digit
     */
    public function get{{&field_name}}Attribute($value) {
        if (!trim($value)) return $value;
        $result = $value;
        return $result;
    }
{{/float_mutators}}
{{#is_view}}
    /**
     * Views usually have no regular factories. The generation of test data
     * usually implies to generate data in others tables.
     * 
     * @param array $argv arguments to pass to referenced factories
     */
    public static function factoryCreate($argv = []) {
        $cnt = self::count();
        // Generating one element
        // [[class_name]]::factory()->create($argv);
        return $cnt;
    }
{{/is_view}}
}